{% load static %}
<!DOCTYPE html>
<html>
<head>
	<!-- META -->
	<meta charset="utf-8" />
	<meta name="viewport" content="width=950">

	<!-- CSS -->
	<link rel="stylesheet" type="text/css" href={% static 'Shop/css/reset.css' %}/>
	<link rel="stylesheet" type="text/css" href={% static 'Shop/css/style.css' %}>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<title>Проект 4 команды, escrow-контракты для интернет-магазина</title>
</head>
<body>
<!-- header-->

<div class="header-container">
	<div class="logo">
		<div class="phone left">
			<h1>Ежедневно c 10:00 до 21:00.</h1>
		</div>
		<div class="command_name">
			<p>Команда №4</p>
			<a href={% url 'index' %}>На главную</a>
		</div>
		<div class="phone right">
			<h1>8 (800) 555 35 35</h1>
			<span class="phone-caption">
				<p>Звоните бесплатно из регионов!</p>
			</span>
			<br>
			<div class="guest_login">
				<form method="POST" id="post-form">
					{% csrf_token %}
					<h3><input type="submit" value="Войти" id="login_but"></h3>
				</form>
			</div>
		</div>
	</div>
</div>
	
<div class="account_info">
	<p id="address" class="address_account">Вы не зашли на сайт со своего кошелька</p>
</div>	
	

<header class="header">
	<div class="clear"></div>
	<div id="infoContainer">
		<a href={% url 'dostavka' %} class="dostavka"><span class="title">Доставка</span>За сутки по СПб,<br/>отправка по всей России!</a>
		<a href={% url 'oplata' %} class="oplata"><span class="title">Оплата</span>0% платежи от регионов,<br/>работаем с юр. лицами!</a>
		<a href={% url 'garanty' %} class="garanty"><span class="title">Гарантия</span>1 год на всю технику!</a>
		<a id="lk" href={% url 'lk' %} class="lk">
			<span class="title">Личный<br>Кабинет</span>
		</a>
		<a href={% url 'contacts' %} class="contacts noBorder"><span class="title">Контакты</span>Работаем каждый день<br/>с 10.00 до 21.00</a>
	</div>

<!-- END header -->

<!-- content -->
<section class="content">
	<ul class="container">
	<li class="static">
			<article class="staticText">
				<h2>Заказы</h2>
				<template id="orders">
					<div class="lk_order">
						<div class="lk_order_top">
							<div class="lk_order_top1">
								<div class="lk_order_top_left">
									<span class="order_time">Заказ от </span>
									<p class="order_id">Номер заказа  </p>
									<p class="order_product">Товар</p>
									<p class="order_buyer_address">Адрес кошелька покупателя</p>
									<p class="order_delivery_address">Адрес доставки</p>
								</div>
								<div class="lk_order_top_right">
									<span class="order_price">120000</span>
									<p class="order_state">Оплачен</p>
								</div>
							</div>
						</div>
						<div class="lk_order_down">
							<button class="btn send_for_delivery_order">Отправить в доставку</button>
							<button class="btn delivered_order">Заказ доставлен</button>
							<button class="btn cancel_seller_order">Отменить заказ</button>
						</div> 
					</div>
				</template>
			</article>
		</li>
	</ul>
	<script type="text/javascript" >
		window.CSRF_TOKEN = "{{ csrf_token }}";

		const admin = "0x0667FA2A9dDF39d6921373FFA82E4a48C31b2a97";
		window.addEventListener('load', function () {
    		// Checking if Web3 has been injected by the browser (Mist/MetaMask)
    		if (typeof web3 !== 'undefined') {
        		// Use Mist/MetaMask's provider
        		console.log("Web3 detected!");
        		window.web3 = new Web3(web3.currentProvider);
        		// Now you can start your app & access web3 freely:
        		console.log("Вы подключены к Блокчейн");
        		var currentNetwork = web3.version.network;
        		if (currentNetwork == 3) {
            		console.log("Вы подключены к Ropsten");
            		changeLkUrl()
        		} else {
            		console.log("Вы не подключены к сети Ropsten");
        		}
    		}
		})

		function changeLkUrl() {
    		let cookie = getCookie('address');
    		console.log(cookie)
    		if (typeof cookie !== "undefined") {
        		console.log("in cookie")
        		addr = cookie;
        		show_address(addr);
        		if (addr == admin.toLowerCase()){
            		changeURLadmin();
        		}
        		else{
            		console.log("user")
            		changeURLUser();
        		}
    		}
		}

		function changeURLadmin(){
			var lk = document.getElementById('lk')
			lk.href='lk_admin';
		}

		function changeURLUser(){
    		console.log("user")
			var lk = document.getElementById('lk')
			lk.href='lk_user';
		}

		function getCookie(name) {
  		let matches = document.cookie.match(new RegExp(
    		"(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
  		));
  		return matches ? decodeURIComponent(matches[1]) : undefined;
		}

		function setCookie(name, value, options = {}) {
   	 		options = {
        		path: '/'
    		};
  			if (options.expires instanceof Date) {
    			options.expires = options.expires.toUTCString();
  			}
  			let updatedCookie = encodeURIComponent(name) + "=" + encodeURIComponent(value);
  			for (let optionKey in options) {
    			updatedCookie += "; " + optionKey;
    			let optionValue = options[optionKey];
    			if (optionValue !== true) {
      			updatedCookie += "=" + optionValue;
    			}
  			}
  			document.cookie = updatedCookie;
		}

		$('#post-form').on('submit', function (event) {
    		let addr = connect()
    		changeLkUrl()
    		show_address(addr)
    		console.log("done")
    		event.preventDefault()
    		console.log("form submitted!")  // sanity check
    		add_user(addr)
		})

		function show_address(addr) {
    		var address = document.getElementById("address");
    		if (typeof addr !== 'undefined') {
        		address.innerHTML = "Вы вошли под кошельком с адресом: " + addr;
    		} else {
        		address.innerHTML = "Нажмите на кнопку входа еще раз";
    		}
		}

		function connect() {
    		if (typeof ethereum !== 'undefined') {
       		ethereum
        		.request({ method: 'eth_requestAccounts' })
        		.catch((error) => {
        		if (error.code === 4001) {
            		// EIP-1193 userRejectedRequest error
            		console.log('Please connect to MetaMask.');
        		} else {
            		console.error(error);
        		}
        		}); 
        		let addr = web3.eth.accounts[0];
        		setCookie('address', encodeURIComponent(addr), {secure: true, 'max-age': 3600});
        		return addr;
    		} else {
        		document.getElementById("address").innerHTML = "Error";
    		}
		}

		function add_user(addr) {
    		console.log("create post is working!") // sanity check
    		$.ajax({
        		type: "POST", // http method
        		data: {
            		the_post: addr,
            		csrfmiddlewaretoken: window.CSRF_TOKEN,
            		action: "add_user"
        		}, // data sent with the post request

        		// handle a successful response
        		success: function (json) {
            		$('#post-text').val(''); // remove the value from the input
            		console.log(json); // log the returned json to the console
            		console.log("success"); // another sanity check
        		},

        		// handle a non-successful response
        		error: function (xhr, errmsg, err) {
            		$('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: " + errmsg +
                		" <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
            		console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
        		}
    		})
		}

		function initContract() {
    		const abi = [{
        		"constant":true,
        		"inputs":[{"name":"id","type":"uint256"}],
        		"name":"CheckState",
        		"outputs":[{"name":"","type":"string"}],
        		"payable":false,
        		"stateMutability":"view",
        		"type":"function"
    		},{
        		"constant":false,
        		"inputs":[{"name":"id","type":"uint256"}],
        		"name":"Refund",
        		"outputs":[],
        		"payable":false,
        		"stateMutability":"nonpayable",
        		"type":"function"
    		},{
        		"constant":false,
        		"inputs":[{"name":"id","type":"uint256"}],
        		"name":"delivered",
        		"outputs":[],
        		"payable":false,
        		"stateMutability":"nonpayable",
        		"type":"function"
    		},{
        		"constant":false,
        		"inputs":[{"name":"id","type":"uint256"}],
        		"name":"CancelOrder",
        		"outputs":[],
        		"payable":false,
        		"stateMutability":"nonpayable",
        		"type":"function"
    		},{
        		"constant":false,
        		"inputs":[{"name":"id","type":"uint256"}],
        		"name":"CancelOrderAdmin",
        		"outputs":[],
        		"payable":false,
        		"stateMutability":"nonpayable","type":"function"
    		},{
        		"constant":false,
        		"inputs":[{"name":"id","type":"uint256"}],
        		"name":"OrderArranged",
        		"outputs":[],
        		"payable":false,
        		"stateMutability":"nonpayable",
        		"type":"function"
    		},{
        		"constant":true,
        		"inputs":[{"name":"id","type":"uint256"}],
        		"name":"getOrder",
        		"outputs":[
            		{"name":"buyer","type":"address"},
            		{"name":"deposit","type":"uint256"},
            		{"name":"currentState","type":"uint8"},
            		{"name":"OrderTime","type":"uint256"}
        		],
        		"payable":false,
        		"stateMutability":"view",
        		"type":"function"
    		},{
        		"constant":false,
        		"inputs":[],
        		"name":"deposit",
        		"outputs":[],
        		"payable":true,
        		"stateMutability":"payable",
        		"type":"function"
    		},{
        		"constant":true,
        		"inputs":[{"name":"buyer","type":"address"}],
        		"name":"getIDs",
        		"outputs":[{"name":"","type":"uint256[]"}],
        		"payable":false,
        		"stateMutability":"view",
        		"type":"function"
    		}]
    		const contract_Address = {
        		"3": "0x50943D5E5214A5f0CdC1802b0797d73BEcD9601d"
    		}
    		try {
        		var current_network = web3.version.network;
        		var contract = web3.eth.contract(abi).at(contract_Address[current_network]);
    		} catch (error) {
        		console.log(error)
    		}
    		return contract;
		}

		function getUsers(){
			var data = JSON.parse("{{data|escapejs}}");
			console.log(data);
		}
  	</script>
</body>
</html>

            



        
        
        
     
